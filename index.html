<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Clearflow</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-50 text-slate-900">
  <div class="max-w-3xl mx-auto p-4 pb-28">
    <div class="flex items-center justify-between gap-3">
      <div>
        <h1 class="text-2xl font-bold tracking-tight">Clearflow</h1>
        <p id="subhead" class="text-sm text-slate-500">Loading…</p>
      </div>
      <div class="flex gap-2">
        <button id="btnAddCustomer" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm font-medium shadow">+ Customer</button>
        <button id="btnAddJob" class="px-3 py-2 rounded-xl bg-white text-slate-900 text-sm font-medium shadow border border-slate-200">+ Job</button>
      </div>
    </div>

    <div class="mt-4 grid grid-cols-5 gap-2">
      <button data-tab="today" class="tab px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm font-medium">Today</button>
      <button data-tab="week" class="tab px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm font-medium">Week</button>
      <button data-tab="overdue" class="tab px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm font-medium">Overdue</button>
      <button data-tab="customers" class="tab px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm font-medium">Customers</button>
      <button data-tab="all" class="tab px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm font-medium">All</button>
    </div>

    <div id="notice" class="mt-4 hidden p-3 rounded-xl bg-amber-50 border border-amber-200 text-amber-900 text-sm"></div>
    <div class="mt-4" id="content"></div>
  </div>

  <div id="modalWrap" class="hidden fixed inset-0 bg-black/40 p-4">
    <div class="max-w-xl mx-auto bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
      <div class="p-4 border-b border-slate-200 flex items-center justify-between">
        <div class="font-semibold" id="modalTitle">Modal</div>
        <button id="btnCloseModal" class="px-2 py-1 rounded-lg hover:bg-slate-100">✕</button>
      </div>
      <div class="p-4" id="modalBody"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, getDocs, query, where, orderBy,
      updateDoc, doc, deleteDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // ✅ Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBKFnGGCcnCq9h-w8wAmvaTeecWidfD5zg",
      authDomain: "round-runner-b497b.firebaseapp.com",
      projectId: "round-runner-b497b",
      storageBucket: "round-runner-b497b.firebasestorage.app",
      messagingSenderId: "234432711618",
      appId: "1:234432711618:web:16bc2c6cef88c8da4be45b"
    };

    const SERVICES = ["Window Clean","Conservatory","Gutter Clean","Fascia + Gutters","Fascia Only"];
    const FREQS = [4, 8, 12];
    const PAYMENTS = ["Cash","Bank Transfer"];

    const $ = (id) => document.getElementById(id);
    const content = $("content");
    const notice = $("notice");
    const subhead = $("subhead");

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let uid = null;
    let activeTab = "today";
    let customers = [];
    let jobs = [];

    // -------- helpers --------
    function val(x, fallback) { return (x === undefined || x === null) ? fallback : x; }
    function str(x, fallback) { x = val(x, ""); x = String(x); return x ? x : fallback; }
    function todayISO(d) {
      d = d || new Date();
      const x = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      return x.toISOString().slice(0, 10);
    }
    function addDays(iso, days) {
      const d = new Date(iso + "T00:00:00");
      d.setDate(d.getDate() + days);
      return d.toISOString().slice(0, 10);
    }
    function pounds(n) { return "£" + Number(val(n, 0)).toFixed(2); }
    function setNotice(msg) {
      if (!msg) { notice.classList.add("hidden"); notice.textContent = ""; return; }
      notice.textContent = msg; notice.classList.remove("hidden");
    }
    function mapLink(address, postcode) {
      const q = encodeURIComponent((str(address,"") + " " + str(postcode,"")).trim());
      return "https://www.google.com/maps/search/?api=1&query=" + q;
    }
    function getCustomerById(id) {
      for (let i = 0; i < customers.length; i++) if (customers[i].id === id) return customers[i];
      return null;
    }

    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        setNotice("Copied invoice text ✅");
        setTimeout(() => setNotice(""), 2000);
      } catch (e) {
        // fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        setNotice("Copied invoice text ✅");
        setTimeout(() => setNotice(""), 2000);
      }
    }

    // -------- modal --------
    function openModal(title, bodyHtml) {
      $("modalTitle").textContent = title;
      $("modalBody").innerHTML = bodyHtml;
      $("modalWrap").classList.remove("hidden");
    }
    function closeModal() { $("modalWrap").classList.add("hidden"); $("modalBody").innerHTML = ""; }
    $("btnCloseModal").addEventListener("click", closeModal);
    $("modalWrap").addEventListener("click", (e) => { if (e.target.id === "modalWrap") closeModal(); });

    // -------- auth --------
    onAuthStateChanged(auth, async (user) => {
      if (!user) return;
      uid = user.uid;
      subhead.textContent = "Ready. Synced via Firebase.";
      await refreshAll();
    });

    async function boot() {
      subhead.textContent = "Signing in…";
      try {
        await signInAnonymously(auth);
      } catch (e) {
        subhead.textContent = "Auth error. Enable Anonymous Auth in Firebase.";
        console.error(e);
      }
    }

    // -------- data --------
    async function loadCustomers() {
      customers = [];
      const qy = query(
        collection(db, "customers"),
        where("ownerUid", "==", uid),
        orderBy("name", "asc")
      );
      const snap = await getDocs(qy);
      snap.forEach(d => customers.push({ id: d.id, ...d.data() }));
    }

    async function loadJobs() {
      jobs = [];
      const qy = query(
        collection(db, "jobs"),
        where("ownerUid", "==", uid),
        orderBy("dueDate", "asc")
      );
      const snap = await getDocs(qy);
      snap.forEach(d => jobs.push({ id: d.id, ...d.data() }));
    }

    async function refreshAll() {
      await Promise.all([loadCustomers(), loadJobs()]);
      render();
    }

    async function createCustomer(data) {
      await addDoc(collection(db, "customers"), {
        ownerUid: uid,
        active: true,
        name: str(data.name, ""),
        phone: str(data.phone, ""),
        email: str(data.email, ""),
        address: str(data.address, ""),
        postcode: str(data.postcode, ""),
        preferredPayment: str(data.preferredPayment, "Cash"),
        notes: str(data.notes, ""),
        createdAt: serverTimestamp()
      });
      await loadCustomers();
    }

    async function createJob(data) {
      await addDoc(collection(db, "jobs"), {
        ownerUid: uid,
        customerId: data.customerId,
        service: str(data.service, "Window Clean"),
        frequencyWeeks: Number(val(data.frequencyWeeks, 4)),
        price: Number(val(data.price, 0)),
        status: "Due",
        paid: false,
        dueDate: data.dueDate,
        paymentMethod: str(data.paymentMethod, "Cash"),
        notes: str(data.notes, ""),
        createdAt: serverTimestamp()
      });
      await loadJobs();
    }

    async function markDone(jobId) {
      await updateDoc(doc(db, "jobs", jobId), { status: "Completed", completedAt: serverTimestamp() });
      await loadJobs();
      render();
    }

    async function markPaid(jobId) {
      await updateDoc(doc(db, "jobs", jobId), { paid: true, paidAt: serverTimestamp() });
      await loadJobs();
      render();
    }

    async function toggleCustomerActive(customerId, active) {
      await updateDoc(doc(db, "customers", customerId), { active: !!active });
      await loadCustomers();
      render();
    }

    async function deleteCustomer(customerId) {
      const ok = confirm("Delete this customer? (This cannot be undone)");
      if (!ok) return;
      await deleteDoc(doc(db, "customers", customerId));
      await loadCustomers();
      render();
    }

    function makeInvoiceText(job, customer) {
      const name = str(customer && customer.name, "there");
      const addr = (str(customer && customer.address, "") + (str(customer && customer.postcode, "") ? (", " + str(customer && customer.postcode, "")) : "")).trim();
      const date = str(job && job.dueDate, "");
      const service = str(job && job.service, "Window Clean");
      const price = pounds(job && job.price);

      return (
`Hi ${name},

Just a quick note to say your ${service} has been completed (${date}).

Amount due: ${price}
${addr ? ("Address: " + addr + "\n") : ""}
Thanks,
Clearflow`
      );
    }

    // -------- UI / render --------
    function render() {
      // tabs style
      document.querySelectorAll(".tab").forEach(b => {
        const is = b.dataset.tab === activeTab;
        b.className = "tab px-3 py-2 rounded-xl text-sm font-medium border " + (is
          ? "bg-slate-900 text-white border-slate-900 shadow"
          : "bg-white text-slate-900 border-slate-200");
      });

      // Customers tab
      if (activeTab === "customers") {
        if (!customers.length) {
          content.innerHTML = `<div class="p-4 rounded-2xl bg-white border border-slate-200 text-slate-600">No customers yet.</div>`;
          return;
        }

        content.innerHTML = customers.map(c => {
          const active = !!c.active;
          const badge = active
            ? `<span class="ml-2 text-xs px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-200">Active</span>`
            : `<span class="ml-2 text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-700 border border-slate-200">Disabled</span>`;

          return `
            <div class="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm mb-3">
              <div class="flex items-center justify-between gap-3">
                <div class="font-semibold">
                  ${str(c.name,"")}
                  ${badge}
                </div>
                <div class="flex gap-2">
                  <button data-action="toggle" data-id="${c.id}" data-active="${active ? "1":"0"}"
                    class="px-3 py-1.5 rounded-lg text-xs font-medium border ${active ? "bg-white border-slate-200" : "bg-slate-900 text-white border-slate-900"}">
                    ${active ? "Disable" : "Enable"}
                  </button>
                  <button data-action="deleteCustomer" data-id="${c.id}"
                    class="px-3 py-1.5 rounded-lg text-xs font-medium border bg-white border-slate-200">
                    Delete
                  </button>
                </div>
              </div>
              <div class="text-sm text-slate-600 mt-1">${str(c.address,"")} ${str(c.postcode,"")}</div>
              <div class="text-sm text-slate-600">${str(c.phone,"")}</div>
            </div>
          `;
        }).join("");

        // wire up buttons
        content.querySelectorAll('[data-action="toggle"]').forEach(btn => {
          btn.addEventListener("click", async () => {
            const id = btn.dataset.id;
            const currentlyActive = btn.dataset.active === "1";
            await toggleCustomerActive(id, !currentlyActive);
          });
        });
        content.querySelectorAll('[data-action="deleteCustomer"]').forEach(btn => {
          btn.addEventListener("click", async () => {
            await deleteCustomer(btn.dataset.id);
          });
        });

        return;
      }

      // Jobs tabs
      const t = todayISO();
      let list = jobs.slice();

      // hide completed by default
      if (activeTab !== "all") {
        list = list.filter(j => str(j.status,"") !== "Completed");
      }

      if (activeTab === "today") list = list.filter(j => str(j.dueDate,"") === t);
      if (activeTab === "week") {
        const end = addDays(t, 6);
        list = list.filter(j => str(j.dueDate,"") >= t && str(j.dueDate,"") <= end);
      }
      if (activeTab === "overdue") list = list.filter(j => str(j.dueDate,"") < t);

      if (!list.length) {
        content.innerHTML = `<div class="p-4 rounded-2xl bg-white border border-slate-200 text-slate-600">Nothing here.</div>`;
        return;
      }

      content.innerHTML = list.map(j => {
        const c = getCustomerById(j.customerId);
        const customerName = c ? str(c.name,"") : "Unknown customer";
        const addr = c ? str(c.address,"") : "";
        const pc = c ? str(c.postcode,"") : "";
        const paid = !!j.paid;

        const paidBadge = paid
          ? `<span class="ml-2 text-xs px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-200">Paid</span>`
          : ``;

        return `
          <div class="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm mb-3">
            <div class="text-sm text-slate-500">${str(j.dueDate,"")} • ${str(j.status,"Due")}${paidBadge}</div>

            <div class="flex items-start justify-between gap-3 mt-1">
              <div>
                <div class="font-semibold">${customerName}</div>
                <div class="text-sm text-slate-700 mt-1">
                  ${str(j.service,"Window Clean")} • ${Number(val(j.frequencyWeeks,4))} weekly •
                  <span class="font-semibold">${pounds(j.price)}</span>
                </div>
                <div class="text-sm text-slate-600 mt-2">${addr}${pc ? ", " + pc : ""}</div>
                <a class="text-sm underline" target="_blank" href="${mapLink(addr, pc)}">Open in Maps</a>
              </div>

              <div class="flex flex-col gap-2">
                <button data-action="done" data-id="${j.id}"
                  class="px-3 py-2 rounded-xl bg-slate-900 text-white text-xs font-medium shadow">
                  Done
                </button>
                <button data-action="paid" data-id="${j.id}"
                  class="px-3 py-2 rounded-xl bg-white text-slate-900 text-xs font-medium shadow border border-slate-200">
                  Paid
                </button>
                <button data-action="invoice" data-id="${j.id}"
                  class="px-3 py-2 rounded-xl bg-white text-slate-900 text-xs font-medium shadow border border-slate-200">
                  Invoice
                </button>
              </div>
            </div>
          </div>
        `;
      }).join("");

      // wire up job action buttons
      content.querySelectorAll('[data-action="done"]').forEach(btn => {
        btn.addEventListener("click", async () => {
          await markDone(btn.dataset.id);
        });
      });

      content.querySelectorAll('[data-action="paid"]').forEach(btn => {
        btn.addEventListener("click", async () => {
          await markPaid(btn.dataset.id);
        });
      });

      content.querySelectorAll('[data-action="invoice"]').forEach(btn => {
        btn.addEventListener("click", async () => {
          const jobId = btn.dataset.id;
          const job = jobs.find(x => x.id === jobId);
          const cust = job ? getCustomerById(job.customerId) : null;
          const text = makeInvoiceText(job, cust);
          await copyToClipboard(text);
        });
      });
    }

    // -------- forms --------
    function openAddCustomer() {
      openModal("Add Customer", `
        <form id="fCustomer" class="grid gap-3">
          <div class="grid gap-1">
            <label class="text-sm font-medium">Name</label>
            <input name="name" class="px-3 py-2 rounded-xl border border-slate-200" required />
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="grid gap-1">
              <label class="text-sm font-medium">Phone</label>
              <input name="phone" class="px-3 py-2 rounded-xl border border-slate-200" />
            </div>
            <div class="grid gap-1">
              <label class="text-sm font-medium">Email</label>
              <input name="email" type="email" class="px-3 py-2 rounded-xl border border-slate-200" />
            </div>
          </div>
          <div class="grid gap-1">
            <label class="text-sm font-medium">Address</label>
            <input name="address" class="px-3 py-2 rounded-xl border border-slate-200" />
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="grid gap-1">
              <label class="text-sm font-medium">Postcode</label>
              <input name="postcode" class="px-3 py-2 rounded-xl border border-slate-200" />
            </div>
            <div class="grid gap-1">
              <label class="text-sm font-medium">Payment</label>
              <select name="preferredPayment" class="px-3 py-2 rounded-xl border border-slate-200">
                ${PAYMENTS.map(p => `<option>${p}</option>`).join("")}
              </select>
            </div>
          </div>
          <div class="grid gap-1">
  <label class="text-sm font-medium">Notes</label>
  <textarea name="notes" rows="3" class="px-3 py-2 rounded-xl border border-slate-200" placeholder="Gate code, dog, best time, etc"></textarea>
</div>

          <button class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm font-medium shadow">Save</button>
        </form>
      `);

      document.getElementById("fCustomer").addEventListener("submit", async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        await createCustomer(Object.fromEntries(fd.entries()));
        closeModal();
        activeTab = "customers";
        render();
      });
    }

    function openAddJob() {
      if (!customers.length) {
        setNotice("Add a customer first.");
        activeTab = "customers";
        render();
        return;
      }

      // Only active customers in the dropdown
      const activeCustomers = customers.filter(c => !!c.active);

      if (!activeCustomers.length) {
        setNotice("No ACTIVE customers. Enable a customer first.");
        activeTab = "customers";
        render();
        return;
      }

      openModal("Add Job", `
        <form id="fJob" class="grid gap-3">
          <div class="grid gap-1">
            <label class="text-sm font-medium">Customer</label>
            <select name="customerId" class="px-3 py-2 rounded-xl border border-slate-200" required>
              ${activeCustomers.map(c => `<option value="${c.id}">${c.name}</option>`).join("")}
            </select>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div class="grid gap-1">
              <label class="text-sm font-medium">Service</label>
              <select name="service" class="px-3 py-2 rounded-xl border border-slate-200">
                ${SERVICES.map(s => `<option>${s}</option>`).join("")}
              </select>
            </div>
            <div class="grid gap-1">
              <label class="text-sm font-medium">Frequency</label>
              <select name="frequencyWeeks" class="px-3 py-2 rounded-xl border border-slate-200">
                ${FREQS.map(f => `<option value="${f}">${f} weekly</option>`).join("")}
              </select>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div class="grid gap-1">
              <label class="text-sm font-medium">Due date</label>
              <input name="dueDate" type="date" class="px-3 py-2 rounded-xl border border-slate-200" value="${todayISO()}" />
            </div>
            <div class="grid gap-1">
              <label class="text-sm font-medium">Price (£)</label>
              <input name="price" type="number" step="0.01" class="px-3 py-2 rounded-xl border border-slate-200" />
            </div>
          </div>

          <button class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm font-medium shadow">Save</button>
        </form>
      `);

      document.getElementById("fJob").addEventListener("submit", async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        await createJob(Object.fromEntries(fd.entries()));
        closeModal();
        activeTab = "today";
        render();
      });
    }

    // -------- events --------
    document.querySelectorAll(".tab").forEach(b =>
      b.addEventListener("click", () => { activeTab = b.dataset.tab; setNotice(""); render(); })
    );
    $("btnAddCustomer").addEventListener("click", openAddCustomer);
    $("btnAddJob").addEventListener("click", openAddJob);

    boot();
  </script>
</body>
</html>

