<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Clearflow</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-50 text-slate-900">
  <div class="max-w-3xl mx-auto p-4 pb-28">
    <div class="flex items-start justify-between gap-3">
      <div>
        <h1 class="text-2xl font-bold tracking-tight">Clearflow</h1>
        <p id="subhead" class="text-sm text-slate-500">Loading…</p>
      </div>
      <div class="flex gap-2">
        <button id="btnAddCustomer" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm font-medium shadow">+ Customer</button>
        <button id="btnAddJob" class="px-3 py-2 rounded-xl bg-white text-slate-900 text-sm font-medium shadow border border-slate-200">+ Job</button>
      </div>
    </div>

    <div class="mt-4 grid grid-cols-7 gap-2">
      <button data-tab="today" class="tab px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm font-medium">Today</button>
      <button data-tab="week" class="tab px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm font-medium">Week</button>
      <button data-tab="overdue" class="tab px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm font-medium">Overdue</button>
      <button data-tab="unpaid" class="tab px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm font-medium">Unpaid</button>
      <button data-tab="calendar" class="tab px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm font-medium">Calendar</button>
      <button data-tab="customers" class="tab px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm font-medium">Customers</button>
      <button data-tab="all" class="tab px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm font-medium">All</button>
    </div>

    <div id="notice" class="mt-4 hidden p-3 rounded-xl bg-amber-50 border border-amber-200 text-amber-900 text-sm"></div>
    <div class="mt-4" id="content"></div>
  </div>

  <div id="modalWrap" class="hidden fixed inset-0 bg-black/40 p-4">
    <div class="max-w-xl mx-auto bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
      <div class="p-4 border-b border-slate-200 flex items-center justify-between">
        <div class="font-semibold" id="modalTitle">Modal</div>
        <button id="btnCloseModal" class="px-2 py-1 rounded-lg hover:bg-slate-100">✕</button>
      </div>
      <div class="p-4" id="modalBody"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, getDocs, query, where,
      updateDoc, doc, deleteDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // ✅ Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBKFnGGCcnCq9h-w8wAmvaTeecWidfD5zg",
      authDomain: "round-runner-b497b.firebaseapp.com",
      projectId: "round-runner-b497b",
      storageBucket: "round-runner-b497b.firebasestorage.app",
      messagingSenderId: "234432711618",
      appId: "1:234432711618:web:16bc2c6cef88c8da4be45b"
    };

    const SERVICES = ["Window Clean","Conservatory","Gutter Clean","Fascia + Gutters","Fascia Only"];
    // weeks: 0 = one-off, 52 = 12 months (same date next year)
    const FREQS = [0, 4, 8, 12, 52];
    const PAYMENTS = ["Cash","Bank Transfer"];

    const $ = (id) => document.getElementById(id);
    const content = $("content");
    const notice = $("notice");
    const subhead = $("subhead");

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let uid = null;
    let activeTab = "today";
    let customers = [];
    let jobs = [];

    // calendar state
    let calYear = new Date().getFullYear();
    let calMonth = new Date().getMonth(); // 0-11

    // ---------- Helpers ----------
    function setNotice(msg) {
      if (!msg) { notice.classList.add("hidden"); notice.textContent = ""; return; }
      notice.textContent = msg; notice.classList.remove("hidden");
    }

    function safeText(s){
      return String(s || "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    function pad2(n){ return String(n).padStart(2, "0"); }

    function todayISO(d) {
      d = d || new Date();
      const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      return `${x.getFullYear()}-${pad2(x.getMonth()+1)}-${pad2(x.getDate())}`;
    }

    function addDaysISO(iso, days) {
      const d = new Date(iso + "T00:00:00");
      d.setDate(d.getDate() + days);
      return todayISO(d);
    }

    // Adds months with clamp: if day doesn't exist in target month, uses last day of month
    function addMonthsISO(iso, months) {
      const d = new Date(iso + "T00:00:00");
      const origDay = d.getDate();
      d.setMonth(d.getMonth() + months);
      if (d.getDate() !== origDay) {
        d.setDate(0);
      }
      return todayISO(d);
    }

    function pounds(n) {
      const x = Number(n || 0);
      return "£" + x.toFixed(2);
    }

    function freqLabel(f) {
      f = Number(f);
      if (f === 0) return "One-off";
      if (f === 52) return "12 months";
      return f + " weekly";
    }

    function mapLink(address, postcode) {
      const q = encodeURIComponent(((address || "") + " " + (postcode || "")).trim());
      return "https://www.google.com/maps/search/?api=1&query=" + q;
    }

    function openModal(title, bodyHtml) {
      $("modalTitle").textContent = title;
      $("modalBody").innerHTML = bodyHtml;
      $("modalWrap").classList.remove("hidden");
    }

    function closeModal() {
      $("modalWrap").classList.add("hidden");
      $("modalBody").innerHTML = "";
    }

    $("btnCloseModal").addEventListener("click", closeModal);
    $("modalWrap").addEventListener("click", (e) => { if (e.target.id === "modalWrap") closeModal(); });

    function startOfWeekMonday(d) {
      d = d || new Date();
      const x = new Date(d);
      x.setHours(0,0,0,0);
      const day = x.getDay(); // 0 Sun.. 1 Mon
      const diff = (day === 0 ? -6 : 1 - day);
      x.setDate(x.getDate() + diff);
      return x;
    }

    function isFirestoreTimestamp(obj) {
      return obj && typeof obj.toDate === "function";
    }

    function paidThisWeekTotal() {
      const start = startOfWeekMonday().getTime();
      let sum = 0;
      for (let i = 0; i < jobs.length; i++) {
        const j = jobs[i];
        if (!j) continue;
        if (j.status !== "Paid") continue;
        if (!isFirestoreTimestamp(j.paidAt)) continue;
        const t = j.paidAt.toDate().getTime();
        if (t >= start) sum += Number(j.price || 0);
      }
      return sum;
    }

    function renderSubhead() {
      subhead.textContent = "Ready. Synced via Firebase. • Paid this week: " + pounds(paidThisWeekTotal());
    }

    function sortCustomersInPlace() {
      customers.sort((a, b) => {
        const an = (a && a.name) ? String(a.name).toLowerCase() : "";
        const bn = (b && b.name) ? String(b.name).toLowerCase() : "";
        return an.localeCompare(bn);
      });
    }

    function sortJobsByDue(list) {
      list.sort((a, b) => {
        const ad = (a && a.dueDate) ? a.dueDate : "";
        const bd = (b && b.dueDate) ? b.dueDate : "";
        if (ad < bd) return -1;
        if (ad > bd) return 1;
        return 0;
      });
      return list;
    }

    function getCustomerById(id) {
      for (let i = 0; i < customers.length; i++) {
        if (customers[i].id === id) return customers[i];
      }
      return null;
    }

    // ---------- Calendar helpers ----------
    function isoFromYMD(y, m, d){
      return `${y}-${pad2(m+1)}-${pad2(d)}`;
    }

    function monthName(m){
      return ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][m];
    }

    function startOfMonthDow(y, m){
      // Monday-based: 0=Mon..6=Sun
      const dow = new Date(y, m, 1).getDay(); // 0 Sun..6 Sat
      return (dow === 0) ? 6 : dow - 1;
    }

    function daysInMonth(y, m){
      return new Date(y, m + 1, 0).getDate();
    }

    // Calendar shows Due + Unpaid, hides Paid
    function jobsOnDate(iso){
      const out = [];
      for (let i = 0; i < jobs.length; i++) {
        const j = jobs[i];
        if (!j) continue;
        if (j.dueDate !== iso) continue;
        if (j.status === "Paid") continue;
        if (j.status !== "Due" && j.status !== "Unpaid") continue;
        out.push(j);
      }
      return out;
    }

    // ---------- Data Load ----------
    async function loadCustomers() {
      customers = [];
      const qy = query(collection(db, "customers"), where("ownerUid", "==", uid));
      const snap = await getDocs(qy);
      snap.forEach(d => customers.push({ id: d.id, ...d.data() }));
      for (let i = 0; i < customers.length; i++) {
        if (customers[i].active === undefined) customers[i].active = true;
      }
      sortCustomersInPlace();
    }

    async function loadJobs() {
      jobs = [];
      const qy = query(collection(db, "jobs"), where("ownerUid", "==", uid));
      const snap = await getDocs(qy);
      snap.forEach(d => jobs.push({ id: d.id, ...d.data() }));
    }

    async function refreshAll() {
      await Promise.all([loadCustomers(), loadJobs()]);
      renderSubhead();
      render();
    }

    // ---------- CRUD Customers ----------
    async function createCustomer(data) {
      await addDoc(collection(db, "customers"), {
        ownerUid: uid,
        active: true,
        name: data.name || "",
        phone: data.phone || "",
        email: data.email || "",
        address: data.address || "",
        postcode: data.postcode || "",
        preferredPayment: data.preferredPayment || "Cash",
        notes: data.notes || "",
        createdAt: serverTimestamp()
      });
      await loadCustomers();
      render();
    }

    async function updateCustomer(customerId, data) {
      await updateDoc(doc(db, "customers", customerId), {
        name: data.name || "",
        phone: data.phone || "",
        email: data.email || "",
        address: data.address || "",
        postcode: data.postcode || "",
        preferredPayment: data.preferredPayment || "Cash",
        notes: data.notes || ""
      });
      await loadCustomers();
      render();
    }

    async function setCustomerActive(customerId, isActive) {
      await updateDoc(doc(db, "customers", customerId), { active: !!isActive });
      await loadCustomers();
      render();
    }

    // ---------- CRUD Jobs ----------
    async function createJob(data) {
      await addDoc(collection(db, "jobs"), {
        ownerUid: uid,
        customerId: data.customerId,
        service: data.service || "Window Clean",
        frequencyWeeks: Number(data.frequencyWeeks || 0),
        price: Number(data.price || 0),
        dueDate: data.dueDate,
        paymentMethod: data.paymentMethod || "Cash",
        notes: data.notes || "",
        status: "Due",     // Due -> Unpaid -> Paid
        paid: false,
        createdAt: serverTimestamp()
      });
      await loadJobs();
      renderSubhead();
      render();
    }

    async function updateJob(jobId, data) {
      await updateDoc(doc(db, "jobs", jobId), {
        customerId: data.customerId,
        service: data.service || "Window Clean",
        frequencyWeeks: Number(data.frequencyWeeks || 0),
        price: Number(data.price || 0),
        dueDate: data.dueDate,
        paymentMethod: data.paymentMethod || "Cash",
        notes: data.notes || ""
      });
      await loadJobs();
      renderSubhead();
      render();
    }

    async function deleteJob(jobId) {
      const ok = confirm("Delete this job? (This cannot be undone)");
      if (!ok) return;
      await deleteDoc(doc(db, "jobs", jobId));
      await loadJobs();
      renderSubhead();
      render();
    }

    async function markDone(jobId) {
      // Done: move job to Unpaid + schedule next if recurring
      let job = null;
      for (let i = 0; i < jobs.length; i++) {
        if (jobs[i].id === jobId) { job = jobs[i]; break; }
      }
      if (!job) return;

      await updateDoc(doc(db, "jobs", jobId), {
        status: "Unpaid",
        doneAt: serverTimestamp()
      });

      const fw = Number(job.frequencyWeeks || 0);
      if (fw !== 0) {
        const baseDue = job.dueDate || todayISO();
        let nextDue = baseDue;

        if (fw === 52) nextDue = addMonthsISO(baseDue, 12);
        else nextDue = addDaysISO(baseDue, fw * 7);

        await addDoc(collection(db, "jobs"), {
          ownerUid: uid,
          customerId: job.customerId,
          service: job.service || "Window Clean",
          frequencyWeeks: fw,
          price: Number(job.price || 0),
          dueDate: nextDue,
          paymentMethod: job.paymentMethod || "Cash",
          notes: job.notes || "",
          status: "Due",
          paid: false,
          createdAt: serverTimestamp()
        });
      }

      await loadJobs();
      renderSubhead();
      render();
    }

    async function markPaid(jobId) {
      await updateDoc(doc(db, "jobs", jobId), {
        status: "Paid",
        paid: true,
        paidAt: serverTimestamp()
      });
      await loadJobs();
      renderSubhead();
      render();
    }

    // ---------- Invoice ----------
    function makeInvoiceText(job, customer) {
      const name = (customer && customer.name) ? customer.name : "there";
      const when = job && job.dueDate ? job.dueDate : "";
      const service = job && job.service ? job.service : "Window Clean";
      const price = pounds(job && job.price ? job.price : 0);

      const addrParts = [];
      if (customer && customer.address) addrParts.push(customer.address);
      if (customer && customer.postcode) addrParts.push(customer.postcode);
      const addrLine = addrParts.length ? ("Address: " + addrParts.join(", ")) : "";

      return (
`Hi ${name},

Just a quick one — your ${service} (${when}) is done.

Amount due: ${price}
${addrLine}

Thanks,
Lewis (Clearflow)`
      );
    }

    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        setNotice("Invoice message copied ✅");
        setTimeout(() => setNotice(""), 2500);
      } catch (e) {
        prompt("Copy this message:", text);
      }
    }

    // ---------- Render ----------
    function setTabsUI() {
      document.querySelectorAll(".tab").forEach(b => {
        const is = b.dataset.tab === activeTab;
        b.className =
          "tab px-3 py-2 rounded-xl text-sm font-medium border " +
          (is ? "bg-slate-900 text-white border-slate-900 shadow"
              : "bg-white text-slate-900 border-slate-200");
      });
    }

    function jobCard(job) {
      const c = getCustomerById(job.customerId);
      const name = c && c.name ? c.name : "Unknown customer";
      const addr = c && c.address ? c.address : "";
      const pc = c && c.postcode ? c.postcode : "";
      const fullAddr = addr + (pc ? (", " + pc) : "");

      const status = job.status || "Due";
      const paidBadge = (status === "Paid") ? `<span class="ml-2 text-xs px-2 py-1 rounded-lg bg-emerald-50 text-emerald-700 border border-emerald-200">Paid</span>` : "";
      const unpaidBadge = (status === "Unpaid") ? `<span class="ml-2 text-xs px-2 py-1 rounded-lg bg-amber-50 text-amber-800 border border-amber-200">Unpaid</span>` : "";

      const notesHtml = job.notes ? `<div class="text-sm text-slate-500 mt-2 whitespace-pre-wrap">${safeText(job.notes)}</div>` : "";

      let buttons = "";
      if (status === "Due") {
        buttons = `
          <button data-action="done" data-id="${job.id}" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm">Done</button>
          <button data-action="editJob" data-id="${job.id}" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm">Edit</button>
          <button data-action="deleteJob" data-id="${job.id}" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm">Delete</button>
          <button data-action="invoice" data-id="${job.id}" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm">Invoice</button>
        `;
      } else if (status === "Unpaid") {
        buttons = `
          <button data-action="paid" data-id="${job.id}" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm">Paid</button>
          <button data-action="editJob" data-id="${job.id}" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm">Edit</button>
          <button data-action="deleteJob" data-id="${job.id}" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm">Delete</button>
          <button data-action="invoice" data-id="${job.id}" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm">Invoice</button>
        `;
      } else {
        buttons = `
          <button data-action="editJob" data-id="${job.id}" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm">Edit</button>
          <button data-action="deleteJob" data-id="${job.id}" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm">Delete</button>
          <button data-action="invoice" data-id="${job.id}" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm">Invoice</button>
        `;
      }

      return `
        <div class="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm mb-3">
          <div class="text-sm text-slate-500">${job.dueDate || ""} • ${status}${paidBadge}${unpaidBadge}</div>
          <div class="font-semibold">${safeText(name)}</div>
          <div class="text-sm text-slate-700 mt-1">
            ${safeText(job.service || "")} • ${safeText(freqLabel(job.frequencyWeeks))} •
            <span class="font-semibold">${pounds(job.price)}</span>
          </div>
          <div class="text-sm text-slate-600 mt-2">${safeText(fullAddr)}</div>
          <a class="text-sm underline" target="_blank" href="${mapLink(addr, pc)}">Open in Maps</a>
          ${notesHtml}
          <div class="mt-3 flex flex-wrap gap-2">${buttons}</div>
        </div>
      `;
    }

    function wireJobButtons() {
      content.querySelectorAll('[data-action="done"]').forEach(btn => {
        btn.addEventListener("click", async () => markDone(btn.dataset.id));
      });
      content.querySelectorAll('[data-action="paid"]').forEach(btn => {
        btn.addEventListener("click", async () => markPaid(btn.dataset.id));
      });
      content.querySelectorAll('[data-action="invoice"]').forEach(btn => {
        btn.addEventListener("click", async () => {
          let job = null;
          for (let i = 0; i < jobs.length; i++) { if (jobs[i].id === btn.dataset.id) { job = jobs[i]; break; } }
          const cust = job ? getCustomerById(job.customerId) : null;
          const txt = makeInvoiceText(job, cust);
          await copyToClipboard(txt);
        });
      });
      content.querySelectorAll('[data-action="editJob"]').forEach(btn => {
        btn.addEventListener("click", () => openEditJob(btn.dataset.id));
      });
      content.querySelectorAll('[data-action="deleteJob"]').forEach(btn => {
        btn.addEventListener("click", async () => deleteJob(btn.dataset.id));
      });
    }

    function renderJobs(list) {
      if (!list.length) {
        content.innerHTML = `<div class="p-4 rounded-2xl bg-white border border-slate-200 text-slate-600">Nothing here.</div>`;
        return;
      }
      content.innerHTML = list.map(jobCard).join("");
      wireJobButtons();
    }

    function renderCustomers() {
      const list = customers.slice().sort((a, b) => {
        const aa = (a.active !== false) ? 1 : 0;
        const bb = (b.active !== false) ? 1 : 0;
        if (aa !== bb) return bb - aa;
        const an = a.name ? String(a.name).toLowerCase() : "";
        const bn = b.name ? String(b.name).toLowerCase() : "";
        return an.localeCompare(bn);
      });

      if (!list.length) {
        content.innerHTML = `<div class="p-4 rounded-2xl bg-white border border-slate-200 text-slate-600">No customers yet.</div>`;
        return;
      }

      content.innerHTML = list.map(c => {
        const isActive = (c.active !== false);
        const badge = isActive
          ? `<span class="ml-2 text-xs px-2 py-1 rounded-lg bg-emerald-50 text-emerald-700 border border-emerald-200">Active</span>`
          : `<span class="ml-2 text-xs px-2 py-1 rounded-lg bg-slate-100 text-slate-700 border border-slate-200">Disabled</span>`;

        const notesHtml = c.notes ? `<div class="text-sm text-slate-500 mt-2 whitespace-pre-wrap">${safeText(c.notes)}</div>` : "";

        return `
          <div class="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm mb-3 ${isActive ? "" : "opacity-70"}">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-semibold">${safeText(c.name || "Unnamed")} ${badge}</div>
                <div class="text-sm text-slate-600">${safeText((c.address || "") + (c.postcode ? (" " + c.postcode) : ""))}</div>
                <div class="text-sm text-slate-600">${safeText(c.phone || "")}</div>
                ${notesHtml}
              </div>
              <div class="flex flex-col gap-2">
                <button data-action="editCustomer" data-id="${c.id}" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm">Edit</button>
                ${
                  isActive
                    ? `<button data-action="disableCustomer" data-id="${c.id}" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm">Disable</button>`
                    : `<button data-action="enableCustomer" data-id="${c.id}" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm">Enable</button>`
                }
              </div>
            </div>
          </div>
        `;
      }).join("");

      content.querySelectorAll('[data-action="disableCustomer"]').forEach(btn => {
        btn.addEventListener("click", async () => setCustomerActive(btn.dataset.id, false));
      });
      content.querySelectorAll('[data-action="enableCustomer"]').forEach(btn => {
        btn.addEventListener("click", async () => setCustomerActive(btn.dataset.id, true));
      });
      content.querySelectorAll('[data-action="editCustomer"]').forEach(btn => {
        btn.addEventListener("click", () => openEditCustomer(btn.dataset.id));
      });
    }

    // ---------- Calendar UI ----------
    function renderCalendar() {
      const firstDow = startOfMonthDow(calYear, calMonth);
      const dim = daysInMonth(calYear, calMonth);

      const cells = [];
      for (let i = 0; i < 42; i++) {
        const dayNum = i - firstDow + 1;
        if (dayNum < 1 || dayNum > dim) {
          cells.push(`<div class="min-h-[96px] bg-white/40 border border-slate-200 rounded-2xl p-2"></div>`);
          continue;
        }

        const iso = isoFromYMD(calYear, calMonth, dayNum);
        const list = jobsOnDate(iso);

        const items = list.slice(0, 3).map(j => {
          const c = getCustomerById(j.customerId);
          const name = c && c.name ? c.name : "Unknown";
          const badge = (j.status === "Unpaid")
            ? `<span class="ml-2 text-[10px] px-1.5 py-0.5 rounded bg-amber-50 border border-amber-200 text-amber-800">Unpaid</span>`
            : ``;
          return `
            <div class="text-xs truncate">
              <span class="font-medium">${safeText(name)}</span>
              <span class="text-slate-500">• ${safeText(j.service || "")}</span>
              ${badge}
            </div>`;
        }).join("");

        const more = (list.length > 3)
          ? `<div class="text-[11px] text-slate-500 mt-1">+${list.length - 3} more</div>`
          : "";

        cells.push(`
          <button data-cal-date="${iso}" class="text-left min-h-[96px] bg-white border border-slate-200 rounded-2xl p-2 hover:border-slate-400">
            <div class="flex items-center justify-between">
              <div class="text-sm font-semibold">${dayNum}</div>
              ${list.length ? `<div class="text-[11px] px-2 py-0.5 rounded-full bg-slate-100 border border-slate-200">${list.length}</div>` : ""}
            </div>
            <div class="mt-1 space-y-1">
              ${items || `<div class="text-xs text-slate-400">No jobs</div>`}
              ${more}
            </div>
          </button>
        `);
      }

      content.innerHTML = `
        <div class="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm">
          <div class="flex items-center justify-between gap-3">
            <div class="font-semibold text-lg">${monthName(calMonth)} ${calYear}</div>
            <div class="flex gap-2">
              <button id="calPrev" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm">◀</button>
              <button id="calToday" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm">Today</button>
              <button id="calNext" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm">▶</button>
            </div>
          </div>

          <div class="mt-3 grid grid-cols-7 gap-2 text-xs text-slate-500">
            <div class="text-center">Mon</div><div class="text-center">Tue</div><div class="text-center">Wed</div>
            <div class="text-center">Thu</div><div class="text-center">Fri</div><div class="text-center">Sat</div><div class="text-center">Sun</div>
          </div>

          <div class="mt-2 grid grid-cols-7 gap-2">
            ${cells.join("")}
          </div>

          <div class="mt-3 text-xs text-slate-500">
            Click a day to view jobs + add a job on that date.
          </div>
        </div>
      `;

      document.getElementById("calPrev").addEventListener("click", () => {
        calMonth -= 1;
        if (calMonth < 0) { calMonth = 11; calYear -= 1; }
        renderCalendar();
      });

      document.getElementById("calNext").addEventListener("click", () => {
        calMonth += 1;
        if (calMonth > 11) { calMonth = 0; calYear += 1; }
        renderCalendar();
      });

      document.getElementById("calToday").addEventListener("click", () => {
        const d = new Date();
        calYear = d.getFullYear();
        calMonth = d.getMonth();
        renderCalendar();
      });

      content.querySelectorAll("[data-cal-date]").forEach(btn => {
        btn.addEventListener("click", () => openCalendarDay(btn.dataset.calDate));
      });
    }

    function openCalendarDay(iso) {
      const list = sortJobsByDue(jobsOnDate(iso).slice());

      const rows = list.length ? list.map(j => {
        const c = getCustomerById(j.customerId);
        const name = c && c.name ? c.name : "Unknown";
        const st = j.status || "Due";
        return `
          <div class="border border-slate-200 rounded-xl p-3">
            <div class="text-sm font-semibold">${safeText(name)}</div>
            <div class="text-sm text-slate-600">${safeText(j.service || "")} • ${safeText(st)} • <span class="font-semibold">${pounds(j.price)}</span></div>
          </div>
        `;
      }).join("") : `<div class="text-sm text-slate-500">No jobs on this date.</div>`;

      openModal(`Jobs on ${iso}`, `
        <div class="grid gap-3">
          <button id="btnAddJobOnDate" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm font-medium shadow">
            + Add job on ${iso}
          </button>
          ${rows}
        </div>
      `);

      document.getElementById("btnAddJobOnDate").addEventListener("click", () => {
        closeModal();
        openAddJob(iso);
      });
    }

    // ---------- Main render switch ----------
    function render() {
      setTabsUI();
      renderSubhead();

      if (activeTab === "customers") {
        renderCustomers();
        return;
      }

      if (activeTab === "calendar") {
        renderCalendar();
        return;
      }

      const t = todayISO();
      const weekEnd = addDaysISO(t, 6);

      let list = jobs.slice();

      if (activeTab !== "all") {
        list = list.filter(j => j.status !== "Paid");
      }

      if (activeTab === "unpaid") {
        list = list.filter(j => j.status === "Unpaid");
        sortJobsByDue(list);
        renderJobs(list);
        return;
      }

      if (activeTab === "today") {
        list = list.filter(j => j.status === "Due" && j.dueDate === t);
      } else if (activeTab === "week") {
        list = list.filter(j => j.status === "Due" && j.dueDate >= t && j.dueDate <= weekEnd);
      } else if (activeTab === "overdue") {
        list = list.filter(j => j.status === "Due" && j.dueDate < t);
      } else if (activeTab === "all") {
        // show everything
      }

      sortJobsByDue(list);
      renderJobs(list);
    }

    // ---------- Forms ----------
    function openAddCustomer() {
      openModal("Add Customer", `
        <form id="fCustomer" class="grid gap-3">
          <div class="grid gap-1">
            <label class="text-sm font-medium">Name</label>
            <input name="name" class="px-3 py-2 rounded-xl border border-slate-200" required />
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div class="grid gap-1">
              <label class="text-sm font-medium">Phone</label>
              <input name="phone" class="px-3 py-2 rounded-xl border border-slate-200" />
            </div>
            <div class="grid gap-1">
              <label class="text-sm font-medium">Email</label>
              <input name="email" type="email" class="px-3 py-2 rounded-xl border border-slate-200" />
            </div>
          </div>

          <div class="grid gap-1">
            <label class="text-sm font-medium">Address</label>
            <input name="address" class="px-3 py-2 rounded-xl border border-slate-200" />
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div class="grid gap-1">
              <label class="text-sm font-medium">Postcode</label>
              <input name="postcode" class="px-3 py-2 rounded-xl border border-slate-200" />
            </div>
            <div class="grid gap-1">
              <label class="text-sm font-medium">Payment</label>
              <select name="preferredPayment" class="px-3 py-2 rounded-xl border border-slate-200">
                ${PAYMENTS.map(p => `<option>${p}</option>`).join("")}
              </select>
            </div>
          </div>

          <div class="grid gap-1">
            <label class="text-sm font-medium">Notes</label>
            <textarea name="notes" rows="3" class="px-3 py-2 rounded-xl border border-slate-200" placeholder="Gate code, dog, best time…"></textarea>
          </div>

          <button class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm font-medium shadow">Save</button>
        </form>
      `);

      document.getElementById("fCustomer").addEventListener("submit", async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        await createCustomer(Object.fromEntries(fd.entries()));
        closeModal();
        activeTab = "customers";
        render();
      });
    }

    function openEditCustomer(customerId) {
      const c = getCustomerById(customerId);
      if (!c) return;

      openModal("Edit Customer", `
        <form id="fEditCustomer" class="grid gap-3">
          <div class="grid gap-1">
            <label class="text-sm font-medium">Name</label>
            <input name="name" value="${safeText(c.name)}" class="px-3 py-2 rounded-xl border border-slate-200" required />
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div class="grid gap-1">
              <label class="text-sm font-medium">Phone</label>
              <input name="phone" value="${safeText(c.phone)}" class="px-3 py-2 rounded-xl border border-slate-200" />
            </div>
            <div class="grid gap-1">
              <label class="text-sm font-medium">Email</label>
              <input name="email" type="email" value="${safeText(c.email)}" class="px-3 py-2 rounded-xl border border-slate-200" />
            </div>
          </div>

          <div class="grid gap-1">
            <label class="text-sm font-medium">Address</label>
            <input name="address" value="${safeText(c.address)}" class="px-3 py-2 rounded-xl border border-slate-200" />
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div class="grid gap-1">
              <label class="text-sm font-medium">Postcode</label>
              <input name="postcode" value="${safeText(c.postcode)}" class="px-3 py-2 rounded-xl border border-slate-200" />
            </div>
            <div class="grid gap-1">
              <label class="text-sm font-medium">Payment</label>
              <select name="preferredPayment" class="px-3 py-2 rounded-xl border border-slate-200">
                ${PAYMENTS.map(p => `<option ${((c.preferredPayment || "Cash") === p) ? "selected" : ""}>${p}</option>`).join("")}
              </select>
            </div>
          </div>

          <div class="grid gap-1">
            <label class="text-sm font-medium">Notes</label>
            <textarea name="notes" rows="3" class="px-3 py-2 rounded-xl border border-slate-200">${safeText(c.notes)}</textarea>
          </div>

          <button class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm font-medium shadow">Save</button>
        </form>
      `);

      document.getElementById("fEditCustomer").addEventListener("submit", async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        await updateCustomer(customerId, Object.fromEntries(fd.entries()));
        closeModal();
      });
    }

    // openAddJob can accept a prefilled date (used by calendar)
    function openAddJob(prefillDate) {
      const activeCustomers = customers.filter(c => c.active !== false);

      if (!activeCustomers.length) {
        setNotice("Add a customer first (or enable one).");
        activeTab = "customers";
        render();
        return;
      }

      const dateVal = prefillDate || todayISO();

      openModal("Add Job", `
        <form id="fJob" class="grid gap-3">
          <div class="grid gap-1">
            <label class="text-sm font-medium">Customer</label>
            <select name="customerId" class="px-3 py-2 rounded-xl border border-slate-200" required>
              ${activeCustomers.map(c => `<option value="${c.id}">${safeText(c.name)}</option>`).join("")}
            </select>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div class="grid gap-1">
              <label class="text-sm font-medium">Service</label>
              <select name="service" class="px-3 py-2 rounded-xl border border-slate-200">
                ${SERVICES.map(s => `<option>${safeText(s)}</option>`).join("")}
              </select>
            </div>
            <div class="grid gap-1">
              <label class="text-sm font-medium">Frequency</label>
              <select name="frequencyWeeks" class="px-3 py-2 rounded-xl border border-slate-200">
                ${FREQS.map(f => `<option value="${f}">${safeText(freqLabel(f))}</option>`).join("")}
              </select>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div class="grid gap-1">
              <label class="text-sm font-medium">Due date</label>
              <input name="dueDate" type="date" class="px-3 py-2 rounded-xl border border-slate-200" value="${dateVal}" />
            </div>
            <div class="grid gap-1">
              <label class="text-sm font-medium">Price (£)</label>
              <input name="price" type="number" step="0.01" class="px-3 py-2 rounded-xl border border-slate-200" />
            </div>
          </div>

          <div class="grid gap-1">
            <label class="text-sm font-medium">Notes</label>
            <textarea name="notes" rows="3" class="px-3 py-2 rounded-xl border border-slate-200" placeholder="Anything about this job…"></textarea>
          </div>

          <button class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm font-medium shadow">Save</button>
        </form>
      `);

      document.getElementById("fJob").addEventListener("submit", async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        await createJob(Object.fromEntries(fd.entries()));
        closeModal();
        activeTab = "today";
        render();
      });
    }

    function openEditJob(jobId) {
      let j = null;
      for (let i = 0; i < jobs.length; i++) { if (jobs[i].id === jobId) { j = jobs[i]; break; } }
      if (!j) return;

      const allCustomers = customers.slice();

      openModal("Edit Job", `
        <form id="fEditJob" class="grid gap-3">
          <div class="grid gap-1">
            <label class="text-sm font-medium">Customer</label>
            <select name="customerId" class="px-3 py-2 rounded-xl border border-slate-200" required>
              ${allCustomers.map(c => `<option value="${c.id}" ${(j.customerId === c.id) ? "selected" : ""}>${safeText(c.name)}</option>`).join("")}
            </select>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div class="grid gap-1">
              <label class="text-sm font-medium">Service</label>
              <select name="service" class="px-3 py-2 rounded-xl border border-slate-200">
                ${SERVICES.map(s => `<option ${(j.service === s) ? "selected" : ""}>${safeText(s)}</option>`).join("")}
              </select>
            </div>
            <div class="grid gap-1">
              <label class="text-sm font-medium">Frequency</label>
              <select name="frequencyWeeks" class="px-3 py-2 rounded-xl border border-slate-200">
                ${FREQS.map(f => `<option value="${f}" ${(Number(j.frequencyWeeks) === Number(f)) ? "selected" : ""}>${safeText(freqLabel(f))}</option>`).join("")}
              </select>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div class="grid gap-1">
              <label class="text-sm font-medium">Due date</label>
              <input name="dueDate" type="date" class="px-3 py-2 rounded-xl border border-slate-200" value="${j.dueDate || todayISO()}" />
            </div>
            <div class="grid gap-1">
              <label class="text-sm font-medium">Price (£)</label>
              <input name="price" type="number" step="0.01" class="px-3 py-2 rounded-xl border border-slate-200" value="${Number(j.price || 0)}" />
            </div>
          </div>

          <div class="grid gap-1">
            <label class="text-sm font-medium">Notes</label>
            <textarea name="notes" rows="3" class="px-3 py-2 rounded-xl border border-slate-200">${safeText(j.notes)}</textarea>
          </div>

          <button class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm font-medium shadow">Save</button>
        </form>
      `);

      document.getElementById("fEditJob").addEventListener("submit", async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        await updateJob(jobId, Object.fromEntries(fd.entries()));
        closeModal();
      });
    }

    // ---------- Events ----------
    document.querySelectorAll(".tab").forEach(b =>
      b.addEventListener("click", () => { activeTab = b.dataset.tab; render(); })
    );

    $("btnAddCustomer").addEventListener("click", openAddCustomer);
    $("btnAddJob").addEventListener("click", () => openAddJob());

    // ---------- Auth Boot ----------
    onAuthStateChanged(auth, async (user) => {
      if (!user) return;
      uid = user.uid;
      await refreshAll();
    });

    async function boot() {
      subhead.textContent = "Signing in…";
      try {
        await signInAnonymously(auth);
      } catch (e) {
        subhead.textContent = "Auth error. Enable Anonymous Auth in Firebase.";
        console.error(e);
      }
    }

    boot();
  </script>
</body>
</html>
