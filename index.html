<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Clearflow</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-50 text-slate-900">
  <div class="max-w-3xl mx-auto p-4 pb-28">
    <div class="flex items-center justify-between gap-3">
      <div>
        <h1 class="text-2xl font-bold tracking-tight">Clearflow</h1>
        <p id="subhead" class="text-sm text-slate-500">Loading…</p>
      </div>
      <div class="flex gap-2">
        <button id="btnAddCustomer" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm font-medium shadow">+ Customer</button>
        <button id="btnAddJob" class="px-3 py-2 rounded-xl bg-white text-slate-900 text-sm font-medium shadow border border-slate-200">+ Job</button>
      </div>
    </div>

    <div class="mt-4 grid grid-cols-5 gap-2">
      <button data-tab="today" class="tab px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm font-medium">Today</button>
      <button data-tab="week" class="tab px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm font-medium">Week</button>
      <button data-tab="overdue" class="tab px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm font-medium">Overdue</button>
      <button data-tab="customers" class="tab px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm font-medium">Customers</button>
      <button data-tab="all" class="tab px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm font-medium">All</button>
    </div>

    <div id="notice" class="mt-4 hidden p-3 rounded-xl bg-amber-50 border border-amber-200 text-amber-900 text-sm"></div>
    <div class="mt-4" id="content"></div>
  </div>

  <div id="modalWrap" class="hidden fixed inset-0 bg-black/40 p-4">
    <div class="max-w-xl mx-auto bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
      <div class="p-4 border-b border-slate-200 flex items-center justify-between">
        <div class="font-semibold" id="modalTitle">Modal</div>
        <button id="btnCloseModal" class="px-2 py-1 rounded-lg hover:bg-slate-100">✕</button>
      </div>
      <div class="p-4" id="modalBody"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, getDocs, query, where, orderBy, updateDoc, doc, deleteDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // ✅ Firebase config (yours)
    const firebaseConfig = {
      apiKey: "AIzaSyBKFnGGCcnCq9h-w8wAmvaTeecWidfD5zg",
      authDomain: "round-runner-b497b.firebaseapp.com",
      projectId: "round-runner-b497b",
      storageBucket: "round-runner-b497b.firebasestorage.app",
      messagingSenderId: "234432711618",
      appId: "1:234432711618:web:16bc2c6cef88c8da4be45b"
    };

    const SERVICES = ["Window Clean","Conservatory","Gutter Clean","Fascia + Gutters","Fascia Only"];
    const FREQS = [4, 8, 12];
    const PAYMENTS = ["Cash","Bank Transfer"];

    const $ = (id) => document.getElementById(id);
    const content = $("content");
    const notice = $("notice");
    const subhead = $("subhead");

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let uid = null;
    let activeTab = "today";
    let customers = [];
    let jobs = [];

    function todayISO(d = new Date()) {
      const x = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      return x.toISOString().slice(0, 10);
    }
    function addDays(iso, days) {
      const d = new Date(iso + "T00:00:00");
      d.setDate(d.getDate() + days);
      return d.toISOString().slice(0, 10);
    }
    function pounds(n) { return "£" + Number(n || 0).toFixed(2); }
    function setNotice(msg) {
      if (!msg) { notice.classList.add("hidden"); notice.textContent = ""; return; }
      notice.textContent = msg; notice.classList.remove("hidden");
    }
    function mapLink(address, postcode) {
      const q = encodeURIComponent(`${address || ""} ${postcode || ""}`.trim());
      return `https://www.google.com/maps/search/?api=1&query=${q}`;
    }

    function openModal(title, bodyHtml) {
      $("modalTitle").textContent = title;
      $("modalBody").innerHTML = bodyHtml;
      $("modalWrap").classList.remove("hidden");
    }
    function closeModal() {
      $("modalWrap").classList.add("hidden");
      $("modalBody").innerHTML = "";
    }
    $("btnCloseModal").addEventListener("click", closeModal);
    $("modalWrap").addEventListener("click", (e) => { if (e.target.id === "modalWrap") closeModal(); });

    // ---------- FIREBASE LOAD/SAVE ----------
    async function loadCustomers() {
      customers = [];
      // show active customers first; inactive still load so you can re-enable
      const qy = query(collection(db, "customers"), where("ownerUid", "==", uid), orderBy("name", "asc"));
      const snap = await getDocs(qy);
      snap.forEach(d => customers.push({ id: d.id, ...d.data() }));
      // default any missing active -> true
      customers = customers.map(c => ({ active: true, ...c }));
    }

    async function loadJobs() {
      jobs = [];
      const qy = query(collection(db, "jobs"), where("ownerUid", "==", uid), orderBy("dueDate", "asc"));
      const snap = await getDocs(qy);
      snap.forEach(d => jobs.push({ id: d.id, ...d.data() }));
    }

    async function refreshAll() {
      await Promise.all([loadCustomers(), loadJobs()]);
      render();
    }

    async function createCustomer(data) {
      await addDoc(collection(db, "customers"), {
        ownerUid: uid,
        active: true,
        name: data.name || "",
        phone: data.phone || "",
        email: data.email || "",
        address: data.address || "",
        postcode: data.postcode || "",
        preferredPayment: data.preferredPayment || "Cash",
        notes: data.notes || "",
        createdAt: serverTimestamp()
      });
      await loadCustomers();
      render();
    }

    async function createJob(data) {
      await addDoc(collection(db, "jobs"), {
        ownerUid: uid,
        customerId: data.customerId,
        service: data.service,
        frequencyWeeks: Number(data.frequencyWeeks),
        price: Number(data.price || 0),
        status: "Due",
        paid: false,
        dueDate: data.dueDate,
        paymentMethod: data.paymentMethod || "Cash",
        notes: data.notes || "",
        createdAt: serverTimestamp()
      });
      await loadJobs();
      render();
    }

    async function markDone(jobId) {
      await updateDoc(doc(db, "jobs", jobId), { status: "Completed" });
      await loadJobs();
      render();
    }

    async function markPaid(jobId) {
      await updateDoc(doc(db, "jobs", jobId), { paid: true, status: "Paid" });
      await loadJobs();
      render();
    }

    async function toggleCustomerActive(customerId, newActive) {
      await updateDoc(doc(db, "customers", customerId), { active: newActive });
      await loadCustomers();
      render();
    }

    async function deleteCustomer(customerId) {
      // Simple: deletes customer record. (It will NOT delete old jobs; those may show "Unknown customer")
      await deleteDoc(doc(db, "customers", customerId));
      await loadCustomers();
      render();
    }

    // ---------- INVOICE MESSAGE ----------
    function makeInvoiceText(job, customer) {
      const name = customer?.name || "there";
      const addr = [customer?.address, customer?.postcode].filter(Boolean).join(", ");
      const date = job?.dueDate || "";
      const service = job?.service || "Window Clean";
      const price = pounds(job?.price || 0);

      return (
`Hi ${name},
Just a quick message from Clearflow — your ${service} was done on ${date}.
Amount due: ${price}
Address: ${addr}

Thanks,
Lewis (Clearflow)`
      );
    }

    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        setNotice("Invoice message copied. Paste it into WhatsApp/text/email.");
        setTimeout(() => setNotice(""), 2500);
      } catch {
        // fallback
        prompt("Copy this message:", text);
      }
    }

    // ---------- UI RENDER ----------
    function setTabsUI() {
      document.querySelectorAll(".tab").forEach(b => {
        const is = b.dataset.tab === activeTab;
        b.className =
          "tab px-3 py-2 rounded-xl text-sm font-medium border " +
          (is ? "bg-slate-900 text-white border-slate-900 shadow"
              : "bg-white text-slate-900 border-slate-200");
      });
    }

    function renderCustomers() {
      const activeFirst = [...customers].sort((a,b) => (b.active === true) - (a.active === true) || (a.name||"").localeCompare(b.name||""));

      content.innerHTML = activeFirst.length
        ? activeFirst.map(c => `
          <div class="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm mb-3">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-semibold">${c.name || "Unnamed"}</div>
                <div class="text-sm text-slate-600">${(c.address || "")} ${(c.postcode || "")}</div>
                <div class="text-sm text-slate-600">${c.phone || ""}</div>
                <div class="text-xs mt-2 inline-block px-2 py-1 rounded-lg ${c.active ? "bg-emerald-50 text-emerald-700 border border-emerald-200" : "bg-slate-100 text-slate-600 border border-slate-200"}">
                  ${c.active ? "Active" : "Disabled"}
                </div>
              </div>

              <div class="flex flex-col gap-2 min-w-[120px]">
                <button data-action="toggleCustomer" data-id="${c.id}" data-active="${c.active ? "1" : "0"}"
                  class="px-3 py-2 rounded-xl text-sm font-medium border ${c.active ? "bg-white border-slate-200" : "bg-slate-900 text-white border-slate-900"}">
                  ${c.active ? "Disable" : "Enable"}
                </button>

                <button data-action="deleteCustomer" data-id="${c.id}"
                  class="px-3 py-2 rounded-xl text-sm font-medium border border-rose-200 bg-rose-50 text-rose-700">
                  Delete
                </button>
              </div>
            </div>
          </div>
        `).join("")
        : `<div class="p-4 rounded-2xl bg-white border border-slate-200 text-slate-600">No customers yet.</div>`;

      // wire up customer buttons
      content.querySelectorAll('[data-action="toggleCustomer"]').forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.dataset.id;
          const active = btn.dataset.active === "1";
          await toggleCustomerActive(id, !active);
        });
      });

      content.querySelectorAll('[data-action="deleteCustomer"]').forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.dataset.id;
          const ok = confirm("Delete this customer? (Jobs will remain but may show 'Unknown customer')");
          if (!ok) return;
          await deleteCustomer(id);
        });
      });
    }

    function renderJobs(list) {
      content.innerHTML = list.length
        ? list.map(j => {
            const c = customers.find(x => x.id === j.customerId);
            const addr = (c?.address || "");
            const pc = (c?.postcode || "");
            const paidBadge = j.paid ? `<span class="ml-2 text-xs px-2 py-1 rounded-lg bg-emerald-50 text-emerald-700 border border-emerald-200">Paid</span>` : "";
            const status = j.status || "Due";

            return `
              <div class="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm mb-3">
                <div class="flex items-start justify-between gap-3">
                  <div>
                    <div class="text-sm text-slate-500">${j.dueDate} • ${status}${paidBadge}</div>
                    <div class="font-semibold">${c?.name || "Unknown customer"}</div>
                    <div class="text-sm text-slate-700 mt-1">
                      ${j.service || "Window Clean"} • ${j.frequencyWeeks || 4} weekly •
                      <span class="font-semibold">${pounds(j.price)}</span>
                    </div>
                    <div class="text-sm text-slate-600 mt-2">${addr}${pc ? ", " + pc : ""}</div>
                    <a class="text-sm underline" target="_blank" href="${mapLink(addr, pc)}">Open in Maps</a>
                  </div>

                  <div class="flex flex-col gap-2 min-w-[120px]">
                    <button data-action="done" data-id="${j.id}"
                      class="px-3 py-2 rounded-xl text-sm font-medium border border-slate-200 bg-white">
                      Done
                    </button>
                    <button data-action="paid" data-id="${j.id}"
                      class="px-3 py-2 rounded-xl text-sm font-medium border border-slate-900 bg-slate-900 text-white">
                      Paid
                    </button>
                    <button data-action="invoice" data-id="${j.id}"
                      class="px-3 py-2 rounded-xl text-sm font-medium border border-slate-200 bg-slate-50">
                      Invoice
                    </button>
                  </div>
                </div>
              </div>
            `;
          }).join("")
        : `<div class="p-4 rounded-2xl bg-white border border-slate-200 text-slate-600">Nothing here.</div>`;

      // wire buttons AFTER innerHTML is set
      content.querySelectorAll('[data-action="done"]').forEach(btn => {
        btn.addEventListener("click", async () => {
          await markDone(btn.dataset.id);
        });
      });

      content.querySelectorAll('[data-action="paid"]').forEach(btn => {
        btn.addEventListener("click", async () => {
          await markPaid(btn.dataset.id);
        });
      });

      content.querySelectorAll('[data-action="invoice"]').forEach(btn => {
        btn.addEventListener("click", async () => {
          const job = jobs.find(x => x.id === btn.dataset.id);
          const cust = customers.find(x => x.id === job?.customerId);
          const text = makeInvoiceText(job, cust);
          await copyToClipboard(text);
        });
      });
    }

    function render() {
      setTabsUI();

      if (activeTab === "customers") {
        renderCustomers();
        return;
      }

      const t = todayISO();
      let list = [...jobs];

      if (activeTab === "today") list = list.filter(j => j.dueDate === t);
      if (activeTab === "week") {
        const end = addDays(t, 6);
        list = list.filter(j => j.dueDate >= t && j.dueDate <= end);
      }
      if (activeTab === "overdue") list = list.filter(j => j.dueDate < t);
      if (activeTab === "all") list = [...jobs];

      // simple: hide completed by default unless All tab
      if (activeTab !== "all") list = list.filter(j => (j.status || "Due") !== "Completed");

      renderJobs(list);
    }

    // ---------- MODALS ----------
    function openAddCustomer() {
      openModal("Add Customer", `
        <form id="fCustomer" class="grid gap-3">
          <div class="grid gap-1">
            <label class="text-sm font-medium">Name</label>
            <input name="name" class="px-3 py-2 rounded-xl border border-slate-200" required />
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div class="grid gap-1">
              <label class="text-sm font-medium">Phone</label>
              <input name="phone" class="px-3 py-2 rounded-xl border border-slate-200" />
            </div>
            <div class="grid gap-1">
              <label class="text-sm font-medium">Email</label>
              <input name="email" type="email" class="px-3 py-2 rounded-xl border border-slate-200" />
            </div>
          </div>

          <div class="grid gap-1">
            <label class="text-sm font-medium">Address</label>
            <input name="address" class="px-3 py-2 rounded-xl border border-slate-200" />
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div class="grid gap-1">
              <label class="text-sm font-medium">Postcode</label>
              <input name="postcode" class="px-3 py-2 rounded-xl border border-slate-200" />
            </div>
            <div class="grid gap-1">
              <label class="text-sm font-medium">Payment</label>
              <select name="preferredPayment" class="px-3 py-2 rounded-xl border border-slate-200">
                ${PAYMENTS.map(p => `<option>${p}</option>`).join("")}
              </select>
            </div>
          </div>

          <button class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm font-medium shadow">Save</button>
        </form>
      `);

      document.getElementById("fCustomer").addEventListener("submit", async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        await createCustomer(Object.fromEntries(fd.entries()));
        closeModal();
        activeTab = "customers";
        render();
      });
    }

    function openAddJob() {
      const activeCustomers = customers.filter(c => c.active);

      if (!activeCustomers.length) {
        setNotice("Add (or re-enable) a customer first.");
        activeTab = "customers";
        render();
        return;
      }

      openModal("Add Job", `
        <form id="fJob" class="grid gap-3">
          <div class="grid gap-1">
            <label class="text-sm font-medium">Customer</label>
            <select name="customerId" class="px-3 py-2 rounded-xl border border-slate-200" required>
              ${activeCustomers.map(c => `<option value="${c.id}">${c.name}</option>`).join("")}
            </select>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div class="grid gap-1">
              <label class="text-sm font-medium">Service</label>
              <select name="service" class="px-3 py-2 rounded-xl border border-slate-200">
                ${SERVICES.map(s => `<option>${s}</option>`).join("")}
              </select>
            </div>
            <div class="grid gap-1">
              <label class="text-sm font-medium">Frequency</label>
              <select name="frequencyWeeks" class="px-3 py-2 rounded-xl border border-slate-200">
                ${FREQS.map(f => `<option value="${f}">${f} weekly</option>`).join("")}
              </select>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div class="grid gap-1">
              <label class="text-sm font-medium">Due date</label>
              <input name="dueDate" type="date" class="px-3 py-2 rounded-xl border border-slate-200" value="${todayISO()}" />
            </div>
            <div class="grid gap-1">
              <label class="text-sm font-medium">Price (£)</label>
              <input name="price" type="number" step="0.01" class="px-3 py-2 rounded-xl border border-slate-200" />
            </div>
          </div>

          <button class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm font-medium shadow">Save</button>
        </form>
      `);

      document.getElementById("fJob").addEventListener("submit", async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        await createJob(Object.fromEntries(fd.entries()));
        closeModal();
        activeTab = "today";
        render();
      });
    }

    // ---------- EVENTS ----------
    document.querySelectorAll(".tab").forEach(b =>
      b.addEventListener("click", () => { activeTab = b.dataset.tab; render(); })
    );
    $("btnAddCustomer").addEventListener("click", openAddCustomer);
    $("btnAddJob").addEventListener("click", openAddJob);

    // ---------- AUTH BOOT ----------
    onAuthStateChanged(auth, async (user) => {
      if (!user) return;
      uid = user.uid;
      subhead.textContent = "Ready. Synced via Firebase.";
      await refreshAll();
    });

    async function boot() {
      subhead.textContent = "Signing in…";
      try {
        await signInAnonymously(auth);
        // onAuthStateChanged will flip it to Ready + load data
      } catch (e) {
        subhead.textContent = "Auth error. Check Firebase Anonymous Auth.";
        console.error(e);
      }
    }

    boot();
  </script>
</body>
</html>
